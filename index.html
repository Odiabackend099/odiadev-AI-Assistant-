<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ODIADEV - Voice AI for Africa</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23d4af37'/%3E%3Ctext x='16' y='21' font-size='14' text-anchor='middle' fill='%231a1f36' font-family='Arial'%3EO%3C/text%3E%3C/svg%3E">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a1f36;color:#fff;height:100vh;display:flex;flex-direction:column}
    .header{background:linear-gradient(135deg,#1a1f36 0%,#2d3561 100%);padding:20px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:space-between}
    .logo{display:flex;align-items:center;gap:15px}
    .logo-icon{width:50px;height:50px;background:linear-gradient(135deg,#4a90e2 0%,#7b68ee 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px}
    .logo-text h1{font-size:2em;font-weight:700;color:#d4af37;margin:0}
    .logo-text p{color:#b0c4de;font-size:.9em;margin:0}
    .status-indicator{display:flex;align-items:center;gap:8px;padding:8px 16px;background:rgba(0,255,136,.1);border-radius:20px;font-size:.9em}
    .status-dot{width:8px;height:8px;background:#00ff88;border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}
    .chat-container{flex:1;display:flex;flex-direction:column;max-width:800px;margin:0 auto;width:100%;padding:0 20px}
    .api-key-section{background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.3);border-radius:12px;padding:16px;margin:20px 0;text-align:center}
    .api-key-input{width:100%;max-width:400px;padding:10px 16px;border:1px solid rgba(255,255,255,.2);border-radius:8px;background:rgba(255,255,255,.05);color:#fff;font-size:14px;margin:8px 0}
    .api-key-input::placeholder{color:rgba(255,255,255,.5)}
    .api-key-button{background:#d4af37;color:#1a1f36;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;margin-left:8px}
    .api-key-button:hover{background:#f4d03f}
    .chat-messages{flex:1;overflow-y:auto;padding:30px 0;display:flex;flex-direction:column;gap:20px}
    .message{display:flex;gap:12px;max-width:80%;animation:slideIn .3s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .message.user{align-self:flex-end;flex-direction:row-reverse}
    .message.assistant{align-self:flex-start}
    .message-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
    .message.user .message-avatar{background:linear-gradient(135deg,#d4af37 0%,#f4d03f 100%)}
    .message.assistant .message-avatar{background:linear-gradient(135deg,#4a90e2 0%,#7b68ee 100%)}
    .message-content{background:rgba(255,255,255,.05);padding:16px 20px;border-radius:18px;line-height:1.5;position:relative;white-space:pre-wrap}
    .message.user .message-content{background:linear-gradient(135deg,#d4af37 0%,#f4d03f 100%);color:#1a1f36}
    .message.assistant .message-content{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1)}
    .input-container{padding:12px 0 24px;border-top:1px solid rgba(255,255,255,.1)}
    .input-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .toggle{display:flex;align-items:center;gap:8px;font-size:.9em;color:#b0c4de}
    .input-wrapper{display:flex;align-items:flex-end;gap:12px;background:rgba(255,255,255,.05);border-radius:24px;padding:16px 20px;border:1px solid rgba(255,255,255,.1);transition:all .3s ease}
    .input-wrapper:focus-within{border-color:#d4af37;box-shadow:0 0 0 3px rgba(212,175,55,.1)}
    .message-input{flex:1;background:none;border:none;color:#fff;font-size:16px;line-height:1.5;resize:none;outline:none;min-height:24px;max-height:120px;font-family:inherit}
    .message-input::placeholder{color:rgba(255,255,255,.5)}
    .send-button{width:32px;height:32px;border:none;background:linear-gradient(135deg,#d4af37 0%,#f4d03f 100%);color:#1a1f36;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s ease;font-size:16px}
    .send-button:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(212,175,55,.3)}
    .send-button:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .welcome-message{text-align:center;padding:40px 20px;color:rgba(255,255,255,.7)}
    .welcome-message h2{color:#d4af37;margin-bottom:16px;font-size:1.5em}
    .welcome-message p{margin-bottom:12px;line-height:1.6}
    .error-message{background:rgba(255,71,87,.1);border:1px solid rgba(255,71,87,.3);color:#ff6b7a;padding:12px 16px;border-radius:12px;margin:10px 0;font-size:.9em}
    .success{background:rgba(0,255,136,.1);border:1px solid rgba(0,255,136,.3);color:#00ff88;padding:12px 16px;border-radius:12px;margin:10px 0;font-size:.9em}
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <div class="logo-icon">üåç</div>
      <div class="logo-text">
        <h1>ODIADEV</h1>
        <p>Voice AI for Africa</p>
      </div>
    </div>
    <div class="status-indicator">
      <div class="status-dot"></div>
      <span id="connectionStatus">Checking‚Ä¶</span>
    </div>
  </div>

  <div class="chat-container">
    <!-- API KEY -->
    <div class="api-key-section" id="apiKeySection">
      <h3 style="color:#d4af37;margin-bottom:10px;">üîê Enter Your ODIADEV API Key</h3>
      <p style="font-size:.9em;margin-bottom:15px;">Your workspace key from the ODIADEV dashboard</p>
      <div>
        <input type="password" class="api-key-input" id="apiKeyInput" placeholder="Enter your API key" />
        <button class="api-key-button" id="saveKeyBtn">Save Key</button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="welcome-message">
        <h2>Welcome to ODIADEV AI</h2>
        <p>Your intelligent Nigerian assistant powered by advanced voice AI.</p>
        <p>Enter your API key above to start chatting!</p>
      </div>
    </div>

    <div class="input-container">
      <div class="input-row">
        <label class="toggle"><input type="checkbox" id="speakToggle" checked/> üîä Speak replies</label>
      </div>
      <div class="input-wrapper">
        <textarea class="message-input" id="messageInput" placeholder="Enter your API key first..." rows="1" disabled></textarea>
        <button class="send-button" id="sendButton" title="Send message" disabled>‚û§</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- State ----------
    let API_KEY = null;
    let isProcessing = false;
    const speakReplies = () => document.getElementById('speakToggle').checked;

    // ---------- DOM ----------
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const apiKeySection = document.getElementById('apiKeySection');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const saveKeyBtn = document.getElementById('saveKeyBtn');
    const conn = document.getElementById('connectionStatus');

    // Restore saved key
    const saved = sessionStorage.getItem('ODIADEV_API_KEY');
    if (saved) {
      API_KEY = saved;
      apiKeySection.style.display = 'none';
      enableChat();
    }

    // Health ping
    (async () => {
      try {
        conn.textContent = 'Pinging‚Ä¶';
        const r = await fetch('/api/health');
        conn.textContent = r.ok ? 'Ready' : 'Degraded';
      } catch(e) {
        conn.textContent = 'Offline';
      }
    })();

    saveKeyBtn.addEventListener('click', () => {
      const key = (apiKeyInput.value || '').trim();
      if (!key) return showError('Enter a valid API key');
      API_KEY = key;
      sessionStorage.setItem('ODIADEV_API_KEY', API_KEY);
      apiKeySection.style.display = 'none';
      enableChat();
      showSuccess('API key set. You can chat now.');
    });

    function enableChat(){
      messageInput.disabled = false;
      sendButton.disabled = false;
      messageInput.placeholder = 'Type your message‚Ä¶';
      messageInput.focus();
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    async function sendMessage(){
      if (!API_KEY) { return showError('Please enter your API key first'); }
      const text = (messageInput.value || '').trim();
      if (!text || isProcessing) return;
      addMessage(text, 'user');
      messageInput.value = '';
      isProcessing = true;
      sendButton.disabled = true;

      try {
        const reply = await chat(text);
        addMessage(reply, 'assistant');
        if (speakReplies()) { try { await speak(reply); } catch(e) {} }
      } catch (err) {
        showError(err.message || 'Failed to get response.');
      } finally {
        isProcessing = false;
        sendButton.disabled = false;
        messageInput.focus();
      }
    }

    async function chat(text){
      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-API-Key': API_KEY },
        body: JSON.stringify({ text })
      });
      if (!r.ok) throw new Error(await r.text());
      const j = await r.json();
      return j.reply || '(no reply)';
    }

    async function speak(text){
      const r = await fetch('/api/tts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-API-Key': API_KEY },
        body: JSON.stringify({ text, voice: 'nigerian-english' })
      });
      if (!r.ok) throw new Error(await r.text());
      const buf = await r.arrayBuffer();
      const blob = new Blob([buf], { type: 'audio/mpeg' });
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      await audio.play();
    }

    function addMessage(text, type){
      const wrap = document.createElement('div');
      wrap.className = 'message ' + (type || 'assistant');
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = type === 'user' ? 'üë§' : 'ü§ñ';
      const content = document.createElement('div');
      content.className = 'message-content';
      content.textContent = text;
      wrap.appendChild(avatar); wrap.appendChild(content);
      chatMessages.appendChild(wrap);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showError(msg){
      const el = document.createElement('div');
      el.className = 'error-message';
      el.textContent = msg;
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      setTimeout(()=>{ if(el.parentNode) el.remove(); }, 5000);
    }
    function showSuccess(msg){
      const el = document.createElement('div');
      el.className = 'success';
      el.textContent = msg;
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      setTimeout(()=>{ if(el.parentNode) el.remove(); }, 3000);
    }
  </script>
</body>
</html>
